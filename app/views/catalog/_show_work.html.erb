<%# default partial to display solr document fields in catalog show view -%>
<script type="text/javascript">
  $(document).ready(function () {
    dkBreve.onDocumentReady();
  });
</script>

<% has_text = document['has_text_ssi'].present? && document['has_text_ssi'] == 'yes' %>
<% has_facs = document['has_facs_ssi'].present? && document['has_facs_ssi'] == 'yes' %>

<!--<div class="container">-->
  <div id="text-landing-page" class="row">
    <div class="col-md-12 contentContainer">
      <div class="letter-metadata">
        <header>
          <a class="pull-left collapseMetadata"><span class="glyphicon glyphicon-chevron-left"></span></a>
        </header>
        <article>
          <dl>
            <%# if @document['volume_id_ssi'].present? %>
            <dt><%#= link_to I18n.t('blacklight.search.index.edition'), "/catalog/" + ERB::Util.url_encode(@document['volume_id_ssi'].to_s)  %></dt>
            <%# end %>
            <% document_show_fields(document).each do |field_name, field| -%>
                <% if (should_render_show_field? document, field) && (document.has?(field_name, /\w/)) %>
                    <dt class="blacklight-<%= field_name.parameterize %>"><%= render_document_show_field_label document, field: field_name %></dt>
                    <dd class="blacklight-<%= field_name.parameterize %>"><%= render_document_show_field_value document, field: field_name %></dd>
                <% end -%>
            <% end -%>
          </dl>
        </article>
      </div>
      <div class="container textAndFacsimileContainer">
        <div class="row">
          <div class="ocrContainer">
            <button id="ocrFullscreenButton" class="btn btn-default pull-right" title="Se tekst i fuld skÃ¦rm">
              <span class="glyphicon glyphicon-fullscreen"></span></button>
            <% if has_text %>
              <div class="downloadLinkContainer">
                <%= link_to(solr_document_path(document, format: :pdf), :target => "_blank", class: 'btn btn-default dlButton') do %>
                    <span class="glyphicon glyphicon-save"></span> Tekst
                <% end %>
              </div>
            <% end %>
            <article class="ocr">
              <% if has_text %>
                  <button class="escFullScreenButton btn btn-default" title="Tilbage til normal visning">
                    <span class="glyphicon glyphicon-remove"></span></button>
                  <%# Get the last query and remove " %>
                  <% query_params = current_search_session.try(:query_params)
                     query = query_params[:q] if  query_params.present?
                    query = query.gsub!(/^\"|\"?$/, '') if query.present? %>
                  <%= FileServer.render_snippet(@document['volume_id_ssi'],
                                                {c: 'texts', xml_id: @document['xmlid_ssi'],
                                                q: query}) %>
              <% else %>
                  Ingen tekst
              <% end %>
            </article>
          </div>
          <div class="facsimile">
            <% if has_facs %>
              <div class="downloadLinkContainer">
                <%= link_to(facsimile_catalog_path(document.id, format: :pdf,), :target => "_blank", class: 'btn btn-default dlButton', :target => "_blank") do %>
                    <span class="glyphicon glyphicon-save"></span> <%= I18n.t('blacklight.search.index.facsimile') %>
                <% end %>
              </div>
            <% end %>
            <article>
              <% if has_facs %>
                  <%# OpenSeadragon start %>
                  <div id="kbOSDInstance" style="height:100%">
                    <div class="kbOSDViewer">
                      <div class="kbOSDContent"></div>
                      <div class="kbOSDFooter"></div>
                    </div>
                  </div>
                  <script type="text/javascript">
                    var kbOSDconfig = [<%= FileServer.openSeadragon_snippet({doc: @document['volume_id_ssi']+'.xml', id: @document['xmlid_ssi']}) %>];
                    // Converting certain strings => numbers, that OpenSeadragon expects to be numbers, but Sigges serializer returns as strings
                    // TODO: This ought to be done serverside, but until we get a better serializer, it's easier to do clientside.
                    // NOTE: If there are more than one kbOSD instance on this page (I don't think there ever will be?), we need to do the following alterations on all config objects!
                    if ('string' === typeof kbOSDconfig[0].initialPage) {
                      kbOSDconfig[0].initialPage = parseInt(kbOSDconfig[0].initialPage, 10);
                    }
                    if ('string' === typeof kbOSDconfig[0].defaultZoomLevel) {
                      kbOSDconfig[0].defaultZoomLevel = parseInt(kbOSDconfig[0].defaultZoomLevel, 10);
                    }
                    if (kbOSDconfig[0].indexPage.length < 2) { // if there is only one element in the index, then don't show any index
                      delete kbOSDconfig[0].indexPage;
                    } else {
                      $.each(kbOSDconfig[0].indexPage, function (index, indexPage) {
                        if ('string' === typeof indexPage.page) {
                          index.page = parseInt(index.page, 10);
                        }
                      });
                    }
                  </script>
                  <script src="https://static.kb.dk/kbOpenSeadragon/js/KbOSD_bundle_min.js"></script>
                  <%# OpenSeadragon end %>
              <% else %>
                  Ingen facsimile
              <% end %>
            </article>
          </div>
        </div>
      </div>
    </div>
  </div>
<!--</div>-->

